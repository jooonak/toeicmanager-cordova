<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"><!--한글 깨짐 문제 해결-->
    <meta http-equiv="Content-Security-Policy" content="default-src *;
   img-src * 'self' data: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' *;
   style-src  'self' 'unsafe-inline' *">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!-- Sets initial viewport load and disables zooming  -->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">

    <!-- Makes your prototype chrome-less once bookmarked to your phone's home screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Include the compiled Ratchet CSS -->
    <link href="dist/css/ratchet.css?ver=1" rel="stylesheet">

    <!-- Include the compiled Ratchet JS -->
    <!-- <script src="dist/js/ratchet.js"></script>-->

    <title>Main</title>
</head>

<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background-image: url('img/back.jpg');
        background-repeat: no-repeat;
        background-size: cover;
    }

    .container {
        display: grid;
        grid-template-areas:
                'header header'
                'contents contents'
                'footer footer';
        grid-auto-rows: 1fr 85% 1fr;
        grid-column-gap: 15px;
        grid-row-gap: 15px;
        text-align: center;
        height: 100%;
        /*width: 100%;
        position: absolute;*/
    }

    .box {
        font-size: 150%;
        margin-right: 15px;
        margin-left: 15px;
        opacity: .8;
    }

    .header {
        grid-column: 1/3;
        grid-row: 1/2;
    }

    .contents {
        grid-column: 1/3;
        grid-row: 2/4;
    }

    .searchPosition{
        min-height: 60px;
        margin-bottom: 3%;
        box-shadow: 0 0 10px #999;
        background-color: white;
    }

    .wordListPosition {
        box-shadow: 0 0 10px #999;
        min-height: 20%;
        margin-bottom: 3%;
    }

    .chatbot{
        box-shadow: 0 0 10px #999;
        min-height: 20%;
        margin-bottom: 3%;

    }

    .result1 {
        position: relative;
        float: left;
        min-height: 20%;
        min-width: 48.5%;
        box-shadow: 0 0 10px #999;
        margin-right: 1.5%;
        font-size: 150%;
        margin-bottom: 3%;
    }

    .result2 {
        position: relative;
        float: left;
        min-height: 20%;
        min-width: 48.5%;
        box-shadow: 0 0 10px #999;
        margin-left: 1.5%;
        font-size: 150%;
        margin-bottom: 3%;
    }

    .progress{
        position: relative;
        min-height: 10%;
        min-width: 100%;
        box-shadow: 0 0 10px #999;
        margin-bottom: 3%;
    }


    .dark {
        background: #222222;
    }

    .camera {
        float: left;
        width: 14%;
        height: 100%;
    }

    .img {
        width: 100%;
        height: 100%;
    }

    .search {
        height: 100%;
        width: 72%;
        float: left;
    }

    #olinput {
        width: 100%;
        margin: 0px;
    }

    .searchBtn{
        float: left;
        width: 14%;
    }

    .dayLeft>h5, .dayRight>h5{
        float: left;
        text-indent: 10px;
    }

    .center {
        display: -webkit-box;
        display: -moz-box;
        display: -ms-flexbox;
        display: -webkit-flex;
        justify-content: center;
        align-items: center;
    }

    .examBtn {
        box-shadow: 0 0 10px #999;
    }

    .meter {
        height: 13px;
        background: #DCE0E3;
        border-radius: 8px;
    }

    .meter > span {
        display: block;
        height: 100%;
        -webkit-border-top-right-radius: 20px;
        -webkit-border-bottom-right-radius: 20px;
        -moz-border-radius-topright: 20px;
        -moz-border-radius-bottomright: 20px;
        border-top-right-radius: 20px;
        border-bottom-right-radius: 20px;
        -webkit-border-top-left-radius: 20px;
        -webkit-border-bottom-left-radius: 20px;
        -moz-border-radius-topleft: 20px;
        -moz-border-radius-bottomleft: 20px;
        border-top-left-radius: 20px;
        border-bottom-left-radius: 20px;
        background-color: darkorange;
        position: relative;
        overflow: hidden;
    }

    .meter > span:after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background-image: -webkit-gradient(linear, 0 0, 100% 100%, color-stop(.25, #f0bb4b), color-stop(.25, transparent), color-stop(.5, transparent), color-stop(.5, #f0bb4b), color-stop(.75, #f0bb4b), color-stop(.75, transparent), to(transparent));
        background-image: -webkit-linear-gradient(-45deg, #f0bb4b 25%, transparent 25%, transparent 50%, #f0bb4b 50%, #f0bb4b 75%, transparent 75%, transparent);
        background-image: -moz-linear-gradient(-45deg, #f0bb4b 25%, transparent 25%, transparent 50%, #f0bb4b 50%, #f0bb4b 75%, transparent 75%, transparent);
        background-image: -ms-linear-gradient(-45deg, #f0bb4b 25%, transparent 25%, transparent 50%, #f0bb4b 50%, #f0bb4b 75%, transparent 75%, transparent);
        background-image: -o-linear-gradient(-45deg, #f0bb4b 25%, transparent 25%, transparent 50%, #f0bb4b 50%, #f0bb4b 75%, transparent 75%, transparent);
        z-index: 1;
        -webkit-background-size: 20px 20px;
        -moz-background-size: 20px 20px;
        background-size: 20px 20px;
        -webkit-animation: move 2s linear infinite;
        -webkit-border-top-right-radius: 20px;
        -webkit-border-bottom-right-radius: 20px;
        -moz-border-radius-topright: 20px;
        -moz-border-radius-bottomright: 20px;
        border-top-right-radius: 20px;
        border-bottom-right-radius: 20px;
        -webkit-border-top-left-radius: 20px;
        -webkit-border-bottom-left-radius: 20px;
        -moz-border-radius-topleft: 20px;
        -moz-border-radius-bottomleft: 20px;
        border-top-left-radius: 20px;
        border-bottom-left-radius: 20px;
        overflow: hidden;
    }

    /* PROGRESS BAR - ANIMATION */
    @-webkit-keyframes move {
        0% {
            background-position: 0 0;
        }
        100% {
            background-position: 30px 30px;
        }
    }

    @-moz-keyframes move {
        0% {
            background-position: 0 0;
        }
        100% {
            background-position: 30px 30px;
        }
    }

    .a{
         background-color: white;
     }

    .a:active{
        background-color:#CCC;
    }


</style>

<body>

<div class='container'>

    <div class=" header ">
        <header class="bar bar-nav dark">
            <button class="btn btn-link btn-nav pull-right"><img style="margin-top: 6px;" class="img" src="img/profile.png"></button>
            <h1 class="title" style="color: white">Toeic Manager</h1>
        </header>
    </div>

    <div class="contents box" >
        <div class="searchPosition center " >

            <div  class="camera center">
                <div id="cameraTakePicture">
                    <img class="img" src="img/camera.png">
                </div>
            </div>

            <div class=" search" >
                <form id="olform" method="GET" action="search.html">
                    <input id="olinput" type="text" name="words" size="15" value="" class="ui-autocomplete-input" autocomplete="off" >
                </form>
            </div>

            <div class="searchBtn">
                <img src="img/serach.png">
            </div>

        </div>

        <div class=" wordListPosition center a">
            단어장리스트
        </div>

        <div class="chatbot center a">
            챗봇 및 명언
        </div>

        <div class="result result1 a">
            <div>
                <h5>학습 목표량</h5>
            </div>
            <div class="center dayLearn">

            </div>
        </div>

        <div class="result result2 a">
            <div>
                <h5>시험 목표량</h5>
            </div>
            <h1 class="center dayExam">

            </h1>
        </div>

        <div class="result progress center a">
            <h5 style="margin-bottom: 20px">달성률　</h5>
            <div class="meter" style="width: 75%;">

            </div>
        </div>

        <div class="button center ">
            <a href="#" class="learnbtn btn  btn-outlined btn-block a examBtn" style="margin-right: 1.5%">
                학습
            </a>
            <a href="#" class="reviewbtn btn  btn-outlined btn-block a examBtn" data-offer="exam" style="margin-left: 1.5%">
                시험
            </a>
        </div>
    </div>


</div>



<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/index.js"></script>
<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript" src="js/getUrlParams.js"></script>
<script type="text/javascript" src="js/slider.js"></script>
<script src="sweetalert2/sweetalert2.min.js"></script>
<link rel="stylesheet" href="sweetalert2/sweetalert2.min.css">
<script type="text/javascript">


    var member = (function (){
        if (localStorage.member === undefined){
            window.location = 'login.html';
        } else {
            return JSON.parse(localStorage.member);
        }
    })();

    $(document).ready(function () {

        $(function(){
            $("#cameraTakePicture").on('click', function(){ // 카메라 버튼 터치시 이벤트 작동
                takePicture(Camera.PictureSourceType.CAMERA); // takePicture() 함수 작동할 때 CAMERA로 사진 찍음(PictureSourceType을 CAMERA로 지정)
            });
        });

        function takePicture(source) { // 위에 버튼 터치시 작동하는 takePicture 함수. Source는 위 코드에 PictureSourceType을 가리킨다. CAMERA나 PHOTOLIBRARY.

            navigator.camera.getPicture( // navigator.camera는 api가 제공하는 global object이다

                function onSuccess(imageData){// getPicture가 성공할 경우에 imageData에 사진의 경로가 담겨서 전달이 된다

                    swal({
                        title: 'please wait..',
                        onOpen: () => {swal.showLoading()},
                    allowOutsideClick: false
                });
                    function getFileEntry(imageData) { // FileEntry라는 객체에 사진을 담아서 스프링 서버로 보내려고 한다
                        window.resolveLocalFileSystemURL(imageData, function success(fileEntry) { // imageData를 받고 그걸 fileEntry라는 객체에다 넣는다
                            console.log("fileEntry: " + fileEntry); // fileEntry: [object Object]
                            console.log("fileEntry.toURL: " + fileEntry.toURL()); // fileEntry.toURL: file:///storage/emulated/0/Android/data/io.cordova.hellocordova/cache/1511838393149.jpg
                            var imageURI = fileEntry.toURL(); // 위에 콘솔에 찍힌 것처럼 사진 파일의 경로를 나타낸다
                            function uploadPhoto(imageURI){// 사진 파일의 경로를 받아 업로드 해주는 함수
                                var options = new FileUploadOptions(); // 파일 업로드 옵션 설정
                                options.chunkedMode = false;
                                options.fileKey = "file"; // 서버에서 받을 때 사용할 키 값
                                options.fileName = imageURI.substr(imageURI.lastIndexOf('/')+1);
                                options.mimeType = "image/jpeg";
                                var fileTransfer = new FileTransfer();
                                fileTransfer.upload(imageURI, encodeURI("http://192.168.0.22:3000/ocr"), win, fail, options); // 마지막으로 서버에 파일 전송을 담당하는 함수.
                            }
                            var win = function (r) { // 얘는 왜 있는건지 아직 사실 잘 모르겠음. Success해도 찍히지 않으니 나중에 누가 알게되면 추가 부탁.
                                console.log(r.response);
                                window.location.href = "cameraresult.html?text="+r.response;

                            }

                            var fail = function (error) {
                                alert("An error has occurred: Code = " + error.code);
                                console.log("upload error source " + error.source);
                                console.log("upload error target " + error.target);

                            }

                            uploadPhoto(imageURI); //

                        });
                    }
                    getFileEntry(imageData); // getFileEntry 함수 실행
                },

                function onFail(message) {
                    alert('Failed because: ' + message);
                },

                { // 카메라의 option 설정
                    destinationType: Camera.DestinationType.FILE_URI, // FILE_URI로 받아오면 사진의 저장경로를 받아온다.
                    encodingType: Camera.EncodingType.JPEG, // JPEG로 저장.
                    quality: 50, // 100이 가장 높은 해상도, 1이 가장 낮은 해상도. Default값이 50.
                    sourceType: Camera.PictureSourceType.CAMERA, // 위에 takePicture 함수에서 parameter로 받아온 것에 따라 다르다. PictureSourceType이 CAMERA나 PHOTOLIBRARY일 수 있다.
                    correctOrientation: true, // 이게 없으면 사진이 90도 돌아서 나온다. 똑바로 나올 수 있게 설정.
//                    saveToPhotoAlbum: true, // 코르도바 앱을 통해 카메라로 사진을 찍을 경우 바로 갤러리에 사진이 저장되게 설정
                    mediaType: Camera.MediaType.PICTURE // 카메라 사용시 사진만 찍을 수 있게 함 (영상금지).
                }
            );
        }

        //학습 및 시험 목표량 정보를 가져오는 함수
        function getList() {
            var obj = [];
            var cycleObj = [];
            var learnObj =[];
            var examObj =[];
            $.getJSON("http://192.168.0.24:8080/result/mainlearn", function (result) {
                for (var i = 0; i < result.length; i++){
                    obj.push({eno : result[i].eno,
                        result : result[i].result,
                        total : result[i].total});
                }
                var str="";
                var sum = 0;
                if(result.length === 1){
                    sum = obj[0].total-obj[0].result;
                    str = "<h1> "+sum+"</h1>";
                }else if(result.length ===0){
                    str = "<h1> "+0+"</h1>";
                }else{
                    for(var i=0; i < result.length; i++){
                        sum +=  obj[i].total-obj[i].result;
                    }
                    str += "<h1 style='color: red'> "+sum+"</h1>";
                }
                $(".dayLearn").html(str);
            });
            $.getJSON("http://192.168.0.24:8080/result/mainexam", function (result) {

                for (var i = 0; i < result.length; i++){
                    cycleObj.push({nextCycle: result[i].nextCycle});
                }

                $(".dayExam").html(result.length);
            });
            $.getJSON("http://192.168.0.24:8080/result/mainbar", function (result) {
                var resultSum = 0;
                var totalSum = 0;
                var date = new Date().getTime();
                var today = ((date+"").slice(0,6)+"0000000");
                for (var i = 0; i < result.learn.length; i++){
                    learnObj.push({result : result.learn[i].result,
                        total : result.learn[i].total});
                    resultSum +=  learnObj[i].result;
                    totalSum += learnObj[i].total;
                }
                for (var i = 0; i < result.exam.length; i++){
                    examObj.push({nextCycle : result.exam[i].nextCycle});
                    if(today >= examObj[i].nextCycle){
                        totalSum += 1;
                    }
                }
                var str ="<span style='width: "+resultSum/totalSum*100+"%;'></span>";
                $(".meter").html(str);
            });
        }
        getList();


        //자동 완성 기능에 대한 이벤트 등록
        $(function () {
            last_req = "";
            $("#olinput").autocomplete({
                minLength: 2,
                delay: 10,
                open: function (event, ui) {
                    //$.off() 메서드는 해당 엘리먼트에 연결된 이벤트(핸들러)를 제거한다. 여기서 'menufocus, hover, mouseenter'가 해당된다.
                    $('.ui-autocomplete').off('menufocus hover mouseenter mouseover');
                },
                //관련 단어를 클릭할 경우에 발생시키는 이벤트이다. 기본 값으로 관련단어 클릭 시 텍스트 창의 단어를 선택된 단어로 변경하는 것이 설정되어 있으므로 따로 설정할 필요는 없다.
                /*select: function(event, ui) {
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'loc',
                        value: 'home_ac_' + last_req
                    }).appendTo('#olform');
                    $( "#olinput" ).val(ui.item.value);
                    $( "#olform" ).submit();
                },*/

                //관련 단어를 가져오는 코드이다. https://jqueryui.com/autocomplete/ 사이트의 view source를 확인하면 쉽게 이해가능하다.
                source: function (request, response) {
                    var res = request.term.split(":");
                    var url;
                    //Datamuse API에 text창에 입력한 문자에 해당하는 글자를 가져오는 url이다. 우리에게 필요한 쿼리가 작성되어 있으므로 쿼리에 대한 설명은 생략한다
                    if (res.length > 1) {
                        url = '//api.datamuse.com/words?v=ol_gte3&max=10&k=ol_clue&sp=' + encodeURIComponent(res[0]) + '&ml=' + encodeURIComponent(res[1]);
                    } else {
                        url = '//api.datamuse.com/sug?v=ol_gte3&k=ol_home&s=' + encodeURIComponent(request.term.replace(/[:].*/, ''));
                    }
                    $.ajax({
                        dataType: "json",
                        type: 'Get',
                        url: url,
                        success: function (data) {
                            response($.map(data, function (item) {
                                return item["word"];
                            }))
                        },
                    });
                    last_req = request.term;
                }
            });
        });

        //검색 버튼에 대한 이벤트 동작
        $(".searchBtn").on("click", function (e) {
            e.preventDefault();
            if($("#olinput").val() === ""){
                swal({
                    title: 'input word',
                    showConfirmButton: true,
                    confirmButtonText: 'ok',
                    showCancelButton: false,
                })
                return;
            }

            var data = {
                key: 'AIzaSyDevHG0cXl0LY6Q0czkfOvnzYuXXcx6B-0',
                q: $("#olinput").val(),
                cx: '005071159500739572678:momm98irnz4'
            };
            $.ajax({
                url: "https://www.googleapis.com/customsearch/v1",
                method: "get",
                data: data,
                success: function (result) {
                    if (result.spelling) {
                        //아래 구문은 모달창에서 할 예정, 임시로 넣어놓음
                        $("#olinput").val(result.spelling.correctedQuery);
                        swal({
                            title: 'Did you find this?',
                            text: 'corrected word: '+result.spelling.correctedQuery,
                            showConfirmButton: true,
                            confirmButtonText: 'right',
                            showCancelButton: true,
                        }).then((result) => {
                            if(result.value){
                            $("#olform").submit();
                        }else {
                            $("#olinput").val('');
                        }
                    });
                    } else {
                        $("#olform").submit();
                    }
                }
            });
        });

        //단어장 리스트 페이지 이동
        $(".wordListPosition").on("click", function (e) {
            window.plugins.nativepagetransitions.slide({ href: "vocabulary.html?mid=m1"});
        });

        //암기현황 구역 클릭시 페이지 이동
        $(".result").on("click", function (e) {
            window.plugins.nativepagetransitions.slide({ href: "result.html?mid=m1"});
        });

        //챗봇 구역 클릭시 페이지 이동
        $(".chatbot").on("click", function (e) {
            window.plugins.nativepagetransitions.slide({ href: "chatbot.html?mid=m1"});
        });

        //btn에 event를 먹이면 검색 부분도 같이 먹여져서 btn-block으로 바꿈
        $(".btn-block").on("click", function (e) {

            if ($(e.target).data("offer")){
                $(this).attr("href", "startpage.html?type=" + $(this).data("offer"));
            } else {
                swal({
                    title: '',
                    html:
                        member.lstatus === "review" ?
                            "<a style='margin: 0; margin-bottom: 5px;' href='#' class='btn btn-block btn-negative btn-outlined'>새로운 단어가 없습니다</a>" +
                            "<a style='margin: 0;' href='startpage.html?type=review' class='btn btn-block btn-positive btn-outlined'>모르는 단어 복습</a>"
                            :
                            "<a style='margin: 0; margin-bottom: 5px;' href='startpage.html?type=learn' class='btn btn-block btn-positive btn-outlined'>새로운 단어 학습</a>" +
                            "<a style='margin: 0;' href='startpage.html?type=review' class='btn btn-block btn-positive btn-outlined'>모르는 단어 복습</a>",
                    showConfirmButton: false,
                    showCancelButton: true
                });
            }

        });
    });
</script>


</body>

</html>